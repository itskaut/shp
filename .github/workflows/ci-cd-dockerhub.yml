name: CI/CD Pipeline - Docker Hub

on:
  push:
    branches: [ "main" ]

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  DOCKERHUB_REPOSITORY: shopper

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    name: Deploy Frontend to shopper repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./shopper/frontend
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}:frontend-${{ github.sha }}
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}:frontend-latest
      
      - name: Frontend deployment info
        run: |
          echo "========================================"
          echo "‚úÖ FRONTEND DEPLOYED TO DOCKER HUB"
          echo "========================================"
          echo ""
          echo "Repository: ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}"
          echo ""
          echo "Tags pushed:"
          echo "  - frontend-latest"
          echo "  - frontend-${{ github.sha }}"
          echo ""
          echo "Docker Hub URL:"
          echo "https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}/tags"
          echo "========================================"

  deploy-api:
    runs-on: ubuntu-latest
    name: Deploy API to shopper repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push API
        uses: docker/build-push-action@v4
        with:
          context: ./shopper/api
          push: true
          tags: |
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}:api-${{ github.sha }}
            ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}:api-latest
      
      - name: API deployment info
        run: |
          echo "========================================"
          echo "‚úÖ API DEPLOYED TO DOCKER HUB"
          echo "========================================"
          echo ""
          echo "Repository: ${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}"
          echo ""
          echo "Tags pushed:"
          echo "  - api-latest"
          echo "  - api-${{ github.sha }}"
          echo ""
          echo "Docker Hub URL:"
          echo "https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}/tags"
          echo "========================================"

  ci-summary:
    runs-on: ubuntu-latest
    name: CI/CD Pipeline Summary
    needs: [deploy-frontend, deploy-api]
    
    steps:
      - name: Generate deployment report
        run: |
          echo "# üöÄ CI/CD PIPELINE - DOCKER HUB DEPLOYMENT"
          echo ""
          echo "## üìä Deployment Status: SUCCESS"
          echo ""
          echo "### üè∑Ô∏è Repository Information"
          echo "- **Docker Hub Username:** ${{ env.DOCKERHUB_USERNAME }}"
          echo "- **Repository:** ${{ env.DOCKERHUB_REPOSITORY }}"
          echo "- **Full Repository URL:** https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}"
          echo ""
          echo "### üì¶ Deployed Images (–≤ –æ–¥–∏–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π)"
          echo ""
          echo "#### üé® Frontend Application"
          echo "- **Tag:** \`frontend-latest\`"
          echo "- **Version:** \`frontend-${{ github.sha }}\`"
          echo "- **Dockerfile Location:** \`./shopper/frontend/Dockerfile\`"
          echo ""
          echo "#### ‚öôÔ∏è API Service"
          echo "- **Tag:** \`api-latest\`"
          echo "- **Version:** \`api-${{ github.sha }}\`"
          echo "- **Dockerfile Location:** \`./shopper/api/Dockerfile\`"
          echo ""
          echo "### üîó Direct Links"
          echo "- **Docker Hub Tags:** https://hub.docker.com/r/${{ env.DOCKERHUB_USERNAME }}/${{ env.DOCKERHUB_REPOSITORY }}/tags"
          echo "- **GitHub Repository:** https://github.com/${{ github.repository }}"
          echo "- **Commit SHA:** ${{ github.sha }}"
          echo ""
          echo "### üìà Pipeline Metrics"
          echo "- **Trigger:** Push to main branch"
          echo "- **Jobs Completed:** 2"
          echo "- **Status:** ‚úÖ –í—Å–µ –æ–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ Docker Hub"
          echo "- **Execution Time:** $(date)"
          echo ""
          echo "---"
          echo "*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ GitHub Actions CI/CD –ø–∞–π–ø–ª–∞–π–Ω–æ–º*"
